<!-- Material Icons import -->
<link
  href="https://fonts.googleapis.com/icon?family=Material+Icons"
  rel="stylesheet"
/>

<!-- Different views based on mode -->
<!-- Accept Purchase Mode (formerly PurchaseAcceptComponent) -->
<div *ngIf="mode === 'accept-purchase'" class="purchase-accept-container">
  <div class="purchase-accept-card">
    <!-- Loading state -->
    <div *ngIf="loading" class="loading-state">
      <div class="spinner"></div>
      <h2>
        Processing Your
        {{ requestType === "license" ? "License" : "Purchase" }} Request
      </h2>
      <p>
        Your {{ requestType === "license" ? "license" : "purchase" }} request is
        being processed and approved. This may take a minute...
      </p>
      <div class="progress-container">
        <div class="progress-dots">
          <span class="dot"></span>
          <span class="dot"></span>
          <span class="dot"></span>
        </div>
        <p class="progress-text">Awaiting approval confirmation</p>
      </div>
      <p class="small-text">
        Please don't close this window. You will be redirected automatically
        once the process is complete.
      </p>
    </div>

    <!-- Success state -->
    <div *ngIf="success" class="success-state">
      <div class="success-icon">
        <i class="material-icons">check_circle</i>
      </div>
      <h2>
        {{ requestType === "license" ? "License" : "Purchase" }} Approved!
      </h2>
      <p class="message">{{ message }}</p>
      <p class="redirect-message">
        You will be redirected automatically in a moment...
      </p>
      <button
        (click)="mode = 'normal'; router.navigate(['/purchase-requests'])"
        class="btn btn-primary"
      >
        Go to Purchase Requests
      </button>
    </div>

    <!-- Error state -->
    <div *ngIf="error" class="error-state">
      <div class="error-icon">
        <i class="material-icons">error_outline</i>
      </div>
      <h2>Something Went Wrong</h2>
      <p class="message">{{ message }}</p>
      <button
        (click)="mode = 'normal'; router.navigate(['/purchase-requests'])"
        class="btn btn-primary"
      >
        Go to Purchase Requests
      </button>
    </div>
  </div>
</div>

<!-- Confirm Purchase Mode -->
<div *ngIf="mode === 'confirm'" class="confirm-page">
  <div class="confirm-container">
    <div class="spinner-container">
      <div class="spinner"></div>
      <div class="spinner-text">Processing your request...</div>
    </div>
    <h2>Confirming Your Purchase</h2>
    <p>Please wait while we securely process your transaction.</p>
    <div class="confirm-details">
      <p><strong>Request ID:</strong> {{ requestId }}</p>
      <p><strong>Email:</strong> {{ userEmail }}</p>
    </div>
  </div>
</div>

<!-- Approve License Mode -->
<div *ngIf="mode === 'approve-license'" class="confirm-page">
  <div class="confirm-container">
    <div class="spinner-container">
      <div class="spinner"></div>
      <div class="spinner-text">Processing your request...</div>
    </div>
    <h2>Approving License Request</h2>
    <p>Please wait while we activate your Google Workspace licenses.</p>
    <div class="confirm-details">
      <p><strong>Request ID:</strong> {{ requestId }}</p>
      <p><strong>License Type:</strong> {{ licenseType }}</p>
      <p><strong>Quantity:</strong> {{ count }}</p>
      <p><strong>Domain:</strong> {{ domain }}</p>
      <p><strong>Email:</strong> {{ userEmail }}</p>
    </div>
  </div>
</div>

<!-- Purchase Success Mode -->
<div *ngIf="mode === 'purchase-success'" class="success-page">
  <div class="success-container">
    <div class="success-icon">
      <i class="material-icons">check_circle</i>
    </div>
    <h1>Request Sent!</h1>
    <div class="message-container">
      <p class="lead">Your purchase request has been sent successfully!</p>
      <div class="details-card">
        <div class="detail-row" *ngIf="requestId">
          <span class="detail-label">Request ID:</span>
          <span class="detail-value">{{ requestId }}</span>
        </div>
        <div class="detail-row" *ngIf="userEmail">
          <span class="detail-label">Email:</span>
          <span class="detail-value">{{ userEmail }}</span>
        </div>
        <div class="detail-row" *ngIf="count">
          <span class="detail-label">Quantity:</span>
          <span class="detail-value">{{ count }}</span>
        </div>
      </div>
      <p>
        A confirmation email has been sent to your email address. Please check
        your inbox to approve the purchase.
      </p>
    </div>
    <div class="button-container">
      <button (click)="mode = 'normal'" class="btn btn-primary">
        View Purchase Requests
      </button>
    </div>
  </div>
</div>

<!-- License Success Mode -->
<div *ngIf="mode === 'license-success'" class="license-success-page">
  <div class="success-container">
    <div class="success-icon">
      <i class="material-icons">check_circle</i>
    </div>
    <h1>License Request Sent!</h1>
    <div class="message-container">
      <p class="lead">
        Your Google Workspace license request has been sent for approval.
      </p>
      <div class="details-card">
        <div class="detail-row" *ngIf="requestId">
          <span class="detail-label">Request ID:</span>
          <span class="detail-value">{{ requestId }}</span>
        </div>
        <div class="detail-row" *ngIf="licenseType">
          <span class="detail-label">License Type:</span>
          <span class="detail-value">{{ licenseType }}</span>
        </div>
        <div class="detail-row" *ngIf="count">
          <span class="detail-label">Number of Licenses:</span>
          <span class="detail-value">{{ count }}</span>
        </div>
        <div class="detail-row" *ngIf="domain">
          <span class="detail-label">Domain:</span>
          <span class="detail-value">{{ domain }}</span>
        </div>
        <div class="detail-row" *ngIf="userEmail">
          <span class="detail-label">Requested By:</span>
          <span class="detail-value">{{ userEmail }}</span>
        </div>
      </div>
      <p>
        A confirmation email has been sent to approve this request. Please check
        your inbox.
      </p>
      <p class="note">
        The license will be added to your Google Workspace account after
        approval.
      </p>
    </div>
    <div class="button-container">
      <button (click)="mode = 'normal'" class="btn btn-primary">
        View Purchase Requests
      </button>
    </div>
  </div>
</div>

<!-- Purchase Error Mode -->
<div *ngIf="mode === 'purchase-error'" class="error-page">
  <div class="error-container">
    <div class="error-icon">
      <span class="material-icons">error</span>
    </div>
    <h2>Purchase Request Error</h2>
    <p class="error-message">
      We encountered an error while processing your purchase request.
    </p>
    <div class="error-details">
      <p *ngIf="requestId"><strong>Request ID:</strong> {{ requestId }}</p>
      <p>
        <strong>Error:</strong>
        {{ errorMessage || "An unexpected error occurred" }}
      </p>
      <p class="error-help">
        Please try again or contact support if this issue persists.
      </p>
    </div>
    <div class="button-container">
      <a href="/" class="btn btn-primary">Return to Dashboard</a>
      <a routerLink="/purchase-requests" class="btn btn-secondary">Try Again</a>
    </div>
  </div>
</div>

<!-- License Error Mode -->
<div *ngIf="mode === 'license-error'" class="error-page">
  <div class="error-container">
    <div class="error-icon">
      <span class="material-icons">error</span>
    </div>
    <h2>License Request Error</h2>
    <p class="error-message">
      We encountered an error while processing your license request.
    </p>
    <div class="error-details">
      <p *ngIf="requestId"><strong>Request ID:</strong> {{ requestId }}</p>
      <p>
        <strong>Error:</strong>
        {{ errorMessage || "An unexpected error occurred" }}
      </p>
      <p class="error-help">
        Please try again or contact support if this issue persists.
      </p>
    </div>
    <div class="button-container">
      <a href="/" class="btn btn-primary">Return to Dashboard</a>
      <a routerLink="/purchase-requests" class="btn btn-secondary">Try Again</a>
    </div>
  </div>
</div>

<!-- Normal Mode: Regular purchase requests UI -->
<div *ngIf="mode === 'normal'" class="purchase-requests-page">
  <!-- Enhanced Header Section -->
  <div class="hero-header">
    <div class="hero-content">
      <div class="hero-icon">
        <span class="material-icons">business_center</span>
      </div>
      <h1 class="hero-title">License & Credits Management</h1>
      <p class="hero-subtitle">
        Streamline your Google Workspace licenses and Signature Satori credits
      </p>
    </div>

    <!-- Company Info Card - Enhanced -->
    <div class="company-info-card" *ngIf="userInfo">
      <div class="company-card-header">
        <div class="company-icon">
          <span class="material-icons">domain</span>
        </div>
        <div class="company-info">
          <h3 class="company-name">
            {{ userInfo?.company || "Your Organization" }}
          </h3>
          <div class="company-meta">
            <div class="meta-item" *ngIf="!userInfo?.isPublicEmail">
              <span class="material-icons">language</span>
              <span>{{ userInfo?.domain }}</span>
            </div>
            <div class="meta-item">
              <span class="material-icons">person</span>
              <span>{{ userInfo?.email }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading & Error States -->
  <div class="loading-container" *ngIf="isLoading">
    <div class="loading-content">
      <div class="spinner-modern"></div>
      <h3>Loading your subscription information</h3>
      <p>Please wait while we gather your license and credit details...</p>
    </div>
  </div>

  <div class="error-container" *ngIf="loadingError">
    <div class="error-content">
      <div class="error-icon">
        <span class="material-icons">cloud_off</span>
      </div>
      <h3>Unable to load subscription data</h3>
      <p>
        We're having trouble connecting to our services. Please try again in a
        moment.
      </p>
      <button class="btn btn-primary retry-btn" (click)="ngOnInit()">
        <span class="material-icons">refresh</span>
        Retry
      </button>
    </div>
  </div>

  <!-- Main Content -->
  <div class="content-container" *ngIf="!isLoading && !loadingError">
    <!-- Google Workspace Section - Enhanced -->
    <section class="google-workspace-section">
      <div class="section-header">
        <div class="section-title-group">
          <div class="logo-container google-logo">
            <img
              src="https://static.dezeen.com/uploads/2025/05/sq-google-g-logo-update_dezeen_2364_col_0.jpg"
              alt="Google"
              class="service-logo"
            />
          </div>
          <div class="title-content">
            <h2>Google Workspace Licenses</h2>
            <p>
              Professional email, cloud storage, and productivity tools for your
              team
            </p>
          </div>
        </div>
      </div>

      <div class="licenses-grid">
        <!-- Business Starter -->
        <div
          class="license-card starter-card"
          [class.has-licenses]="hasLicenseType('Business Starter')"
        >
          <div class="card-header">
            <div class="plan-badge starter-badge">Essential</div>
            <h3>Business Starter</h3>
            <div class="price">
              <span class="currency">$</span>
              <span class="amount">7</span>
              <span class="period">per user/month</span>
            </div>
          </div>

          <div class="features-list">
            <div class="feature-item">
              <span class="material-icons">cloud</span>
              <span>30 GB storage per user</span>
            </div>
            <div class="feature-item">
              <span class="material-icons">email</span>
              <span
                >Professional email {{ "@"
                }}{{ userInfo?.displayDomain || "your-domain.com" }}</span
              >
            </div>
            <div class="feature-item">
              <span class="material-icons">psychology</span>
              <span>AI assistant Gemini in Gmail</span>
            </div>
            <div class="feature-item">
              <span class="material-icons">videocam</span>
              <span>Video meetings (100 participants)</span>
            </div>
          </div>

          <div class="license-status">
            <div class="current-count">
              <span class="count-label">Active Licenses</span>
              <span class="count-number">{{
                getLicenseCount("Business Starter")
              }}</span>
            </div>
          </div>

          <button
            class="add-license-btn"
            (click)="openLicensePurchaseModal('Business Starter')"
          >
            <span class="material-icons">add</span>
            Add Licenses
          </button>
        </div>

        <!-- Business Standard -->
        <div
          class="license-card standard-card featured-card"
          [class.has-licenses]="hasLicenseType('Business Standard')"
        >
          <div class="popular-ribbon">Most Popular</div>
          <div class="card-header">
            <div class="plan-badge standard-badge">Recommended</div>
            <h3>Business Standard</h3>
            <div class="price">
              <span class="currency">$</span>
              <span class="amount">14</span>
              <span class="period">per user/month</span>
            </div>
          </div>

          <div class="features-list">
            <div class="feature-item">
              <span class="material-icons">cloud</span>
              <span>2 TB storage per user</span>
            </div>
            <div class="feature-item">
              <span class="material-icons">email</span>
              <span
                >Professional email {{ "@"
                }}{{ userInfo?.displayDomain || "your-domain.com" }}</span
              >
            </div>
            <div class="feature-item">
              <span class="material-icons">psychology</span>
              <span>Enhanced AI in Gmail, Docs, Meet</span>
            </div>
            <div class="feature-item">
              <span class="material-icons">videocam</span>
              <span>Video meetings (150 participants)</span>
            </div>
            <div class="feature-item">
              <span class="material-icons">edit</span>
              <span>E-signatures & advanced features</span>
            </div>
          </div>

          <div class="license-status">
            <div class="current-count">
              <span class="count-label">Active Licenses</span>
              <span class="count-number">{{
                getLicenseCount("Business Standard")
              }}</span>
            </div>
          </div>

          <button
            class="add-license-btn featured"
            (click)="openLicensePurchaseModal('Business Standard')"
          >
            <span class="material-icons">add</span>
            Add Licenses
          </button>
        </div>

        <!-- Business Plus -->
        <div
          class="license-card plus-card"
          [class.has-licenses]="hasLicenseType('Business Plus')"
        >
          <div class="card-header">
            <div class="plan-badge plus-badge">Advanced</div>
            <h3>Business Plus</h3>
            <div class="price">
              <span class="currency">$</span>
              <span class="amount">22</span>
              <span class="period">per user/month</span>
            </div>
          </div>

          <div class="features-list">
            <div class="feature-item">
              <span class="material-icons">cloud</span>
              <span>5 TB storage per user</span>
            </div>
            <div class="feature-item">
              <span class="material-icons">email</span>
              <span
                >Professional email {{ "@"
                }}{{ userInfo?.displayDomain || "your-domain.com" }}</span
              >
            </div>
            <div class="feature-item">
              <span class="material-icons">security</span>
              <span>Enhanced security & management</span>
            </div>
            <div class="feature-item">
              <span class="material-icons">videocam</span>
              <span>Video meetings (500 participants)</span>
            </div>
            <div class="feature-item">
              <span class="material-icons">admin_panel_settings</span>
              <span>Advanced endpoint management</span>
            </div>
          </div>

          <div class="license-status">
            <div class="current-count">
              <span class="count-label">Active Licenses</span>
              <span class="count-number">{{
                getLicenseCount("Business Plus")
              }}</span>
            </div>
          </div>

          <button
            class="add-license-btn"
            (click)="openLicensePurchaseModal('Business Plus')"
          >
            <span class="material-icons">add</span>
            Add Licenses
          </button>
        </div>
      </div>
    </section>

    <!-- Signature Satori Section - Enhanced -->
    <section class="signature-satori-section">
      <div class="section-header">
        <div class="section-title-group">
          <div class="logo-container satori-logo">
            <img
              src="https://signaturesatori.com/wp-content/uploads/SignatureSatori_Logo_for_Google.png"
              alt="Signature Satori"
              class="service-logo"
            />
          </div>
          <div class="title-content">
            <h2>Signature Satori Credits</h2>
            <p>
              Automated document processing and signature management solutions
            </p>
          </div>
        </div>
      </div>

      <div class="credits-dashboard">
        <div class="credits-info-card">
          <div class="balance-display">
            <div class="balance-icon">
              <span class="material-icons">account_balance_wallet</span>
            </div>
            <div class="balance-content">
              <div class="balance-label">Current Balance</div>
              <div class="balance-value">
                <span class="amount">{{
                  creditBalance | number : "1.0-0"
                }}</span>
                <span class="unit">credits</span>
              </div>
            </div>
          </div>

          <div class="credits-info">
            <div class="info-item">
              <span class="material-icons">info</span>
              <span>One credit per document processed</span>
            </div>
            <div class="info-item">
              <span class="material-icons">attach_money</span>
              <span>$0.50 per credit when purchasing in bulk</span>
            </div>
          </div>
        </div>

        <div class="credits-action-card">
          <div class="action-content">
            <h3>Need more credits?</h3>
            <p>
              Purchase credits in bulk to process more documents efficiently
            </p>
            <button
              class="purchase-credits-btn"
              (click)="openCreditsPurchaseModal()"
            >
              <span class="material-icons">add_circle</span>
              Purchase Credits
            </button>
          </div>
        </div>
      </div>
    </section>

    <!-- Recent Activity Section - Enhanced -->
    <section class="recent-activity-section">
      <div class="section-header">
        <div class="section-title-group">
          <div class="icon-container">
            <span class="material-icons">receipt_long</span>
          </div>
          <div class="title-content">
            <h2>Recent Activity</h2>
            <p>Track your license and credit requests from the last 30 days</p>
          </div>
        </div>
        <div class="header-actions">
          <button
            class="btn btn-icon refresh-btn"
            (click)="refreshPurchaseRequests()"
            title="Refresh"
          >
            <span class="material-icons">refresh</span>
          </button>
          <button
            class="btn btn-outline view-all-btn"
            (click)="showAllRequests = !showAllRequests"
          >
            <span class="material-icons">{{
              showAllRequests ? "visibility_off" : "visibility"
            }}</span>
            {{ showAllRequests ? "Show Recent" : "View All" }}
          </button>
        </div>
      </div>

      <div
        class="activity-container"
        *ngIf="pendingRequests.length > 0; else noActivity"
      >
        <div class="activity-list">
          <div
            class="activity-item"
            *ngFor="
              let request of getDisplayedRequests();
              trackBy: trackByRequestId
            "
            [class]="getRequestTypeClass(request.type)"
          >
            <!-- Service Logo -->
            <img
              [src]="getServiceLogo(request.type)"
              [alt]="getServiceName(request.type)"
              class="service-logo"
            />

            <div class="activity-content">
              <div class="activity-header">
                <h4>{{ formatActivityTitle(request) }}</h4>
                <div
                  class="status-badge"
                  [class]="getStatusBadgeClass(request.status)"
                >
                  <span class="status-text">{{
                    formatStatus(request.status)
                  }}</span>
                </div>
              </div>

              <div class="activity-details">
                <div class="detail-item">
                  <span class="detail-label">Quantity</span>
                  <span class="detail-value"
                    >{{ request.quantity }}
                    {{ getQuantityUnit(request.type) }}</span
                  >
                </div>
                <div class="detail-item">
                  <span class="detail-label">Cost</span>
                  <span class="detail-value">{{
                    request.cost | currency : "USD" : "symbol" : "1.2-2"
                  }}</span>
                </div>
              </div>
            </div>

            <div class="activity-date">
              {{ formatDate(request.requestDate) }}
            </div>
          </div>
        </div>

        <!-- Load More Button -->
        <div
          class="load-more-container"
          *ngIf="hasMoreRequests && showAllRequests"
        >
          <button
            class="btn btn-outline load-more-btn"
            (click)="loadMoreRequests()"
          >
            <span class="material-icons">expand_more</span>
            Load More Requests
          </button>
        </div>
      </div>

      <ng-template #noActivity>
        <div class="no-activity-state">
          <div class="no-activity-icon">
            <span class="material-icons">inbox</span>
          </div>
          <h3>No recent activity</h3>
          <p>
            Your license and credit requests will appear here once you start
            making purchases.
          </p>
          <div class="quick-actions">
            <button
              class="btn btn-primary"
              (click)="openLicensePurchaseModal('Business Standard')"
            >
              <span class="material-icons">business</span>
              Add Google Licenses
            </button>
            <button
              class="btn btn-secondary"
              (click)="openCreditsPurchaseModal()"
            >
              <span class="material-icons">verified</span>
              Purchase Satori Credits
            </button>
          </div>
        </div>
      </ng-template>
    </section>
  </div>

  <!-- License Purchase Modal - Enhanced -->
  <div class="modal-overlay" *ngIf="showLicenseModal" (click)="closeModals()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-title-group">
          <div class="modal-icon google-modal">
            <img
              src="https://static.dezeen.com/uploads/2025/05/sq-google-g-logo-update_dezeen_2364_col_0.jpg"
              alt="Google"
              class="modal-logo"
            />
          </div>
          <h3>Purchase Google Workspace Licenses</h3>
        </div>
        <button class="close-button" (click)="closeModals()">
          <span class="material-icons">close</span>
        </button>
      </div>

      <div class="modal-body">
        <div class="license-type-display">
          <h4>{{ selectedLicenseType }}</h4>
          <div class="license-price">
            {{ getLicensePrice(selectedLicenseType) }} per user/month
          </div>
        </div>

        <div class="form-control">
          <label for="licenseQuantity">Number of licenses to purchase:</label>
          <input
            type="number"
            id="licenseQuantity"
            [(ngModel)]="purchaseLicenseQuantity"
            min="1"
            max="100"
            step="1"
          />
        </div>

        <div class="cost-summary">
          <div class="summary-row">
            <span class="label">License type:</span>
            <span class="value">{{ selectedLicenseType }}</span>
          </div>
          <div class="summary-row">
            <span class="label">Price per license:</span>
            <span class="value">{{
              getLicensePrice(selectedLicenseType)
            }}</span>
          </div>
          <div class="summary-row">
            <span class="label">Quantity:</span>
            <span class="value">{{ purchaseLicenseQuantity }} license(s)</span>
          </div>
          <div class="summary-row total">
            <span class="label">Monthly cost:</span>
            <span class="value">${{ calculateLicenseCost() }}</span>
          </div>
          <div class="summary-row total-year">
            <span class="label">Yearly cost:</span>
            <span class="value">${{ calculateLicenseCost() * 12 }}</span>
          </div>
        </div>

        <div class="approval-notice">
          <span class="material-icons">info</span>
          <span>A confirmation email will be sent directly to you.</span>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn" (click)="closeModals()">Cancel</button>
        <button class="btn btn-primary" (click)="purchaseLicenses()">
          Submit License Request
        </button>
      </div>
    </div>
  </div>

  <!-- Credits Purchase Modal - Enhanced -->
  <div class="modal-overlay" *ngIf="showCreditsModal" (click)="closeModals()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-title-group">
          <div class="modal-icon satori-modal">
            <img
              src="https://signaturesatori.com/wp-content/uploads/SignatureSatori_Logo_for_Google.png"
              alt="Signature Satori"
              class="modal-logo"
            />
          </div>
          <h3>Purchase Signature Satori Credits</h3>
        </div>
        <button class="close-button" (click)="closeModals()">
          <span class="material-icons">close</span>
        </button>
      </div>

      <div class="modal-body">
        <p>Add Signature Satori credits to your account at $0.50 per credit.</p>

        <div class="form-control">
          <label for="creditsQuantity">Number of credits to purchase:</label>
          <input
            type="number"
            id="creditsQuantity"
            [(ngModel)]="purchaseQuantity"
            min="100"
            max="10000"
            step="100"
          />
        </div>

        <div class="cost-summary">
          <div class="summary-row">
            <span class="label">Unit price:</span>
            <span class="value">$0.50/credit</span>
          </div>
          <div class="summary-row">
            <span class="label">Quantity:</span>
            <span class="value">{{ purchaseQuantity }} credits</span>
          </div>
          <div class="summary-row total">
            <span class="label">Total cost:</span>
            <span class="value">${{ calculateCreditsCost() }}</span>
          </div>
        </div>

        <div class="approval-notice">
          <span class="material-icons">info</span>
          <span>A confirmation email will be sent directly to you.</span>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn" (click)="closeModals()">Cancel</button>
        <button class="btn btn-primary" (click)="purchaseCredits()">
          Submit Purchase Request
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Custom Toast Notification -->
<div
  class="custom-toast"
  *ngIf="showNotification"
  [ngClass]="{
    'toast-success': notificationType === 'success',
    'toast-error': notificationType === 'error'
  }"
>
  <div class="toast-content">
    <span class="material-icons">
      {{ notificationType === "success" ? "check_circle" : "error" }}
    </span>
    <span class="toast-message">{{ notificationMessage }}</span>
  </div>
</div>
