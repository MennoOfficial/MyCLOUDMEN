<div class="company-detail-container">
  <!-- Back button and header -->
  <div class="detail-header">
    <button class="back-button" (click)="goBack()">
      <span class="material-icons">arrow_back</span>
      Back to Companies
    </button>
    <div class="header-content">
      <h1 class="company-name" *ngIf="company">{{ company.name }}</h1>

      <!-- Notification bell with popup -->
      <div class="notification-container" *ngIf="hasPendingUsers">
        <button
          class="notification-bell"
          title="Pending account requests"
          (click)="toggleNotificationPopup($event)"
          aria-label="Show pending account requests"
        >
          <span class="material-icons">notifications_active</span>
          <span class="notification-count">{{ pendingCount }}</span>
        </button>

        <!-- Notification Popup -->
        <div class="notification-popup" *ngIf="showNotificationPopup">
          <div class="notification-header">
            <h3>Pending Account Requests</h3>
            <span class="notification-count-badge">{{ pendingCount }}</span>
          </div>

          <div class="notification-content">
            <div
              class="notification-item"
              *ngFor="let user of pendingUsers"
              (click)="showPendingUserActions(user)"
            >
              <div class="notification-user-info">
                <div class="notification-user-name">{{ user.name }}</div>
                <div class="notification-user-email">{{ user.email }}</div>
                <div class="notification-time">
                  {{ formatTimeAgo(user.requestedAt) }}
                </div>
              </div>
              <div class="notification-actions">
                <button
                  class="action-btn reject-btn"
                  (click)="rejectUser(user.id); $event.stopPropagation()"
                  title="Reject user"
                  aria-label="Reject user request"
                >
                  <span class="material-icons">close</span>
                </button>
                <button
                  class="action-btn approve-btn"
                  (click)="approveUser(user.id); $event.stopPropagation()"
                  title="Approve user"
                  aria-label="Approve user request"
                >
                  <span class="material-icons">check</span>
                </button>
              </div>
            </div>
          </div>

          <div class="notification-footer" *ngIf="pendingUsers.length === 0">
            <p>No pending requests</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="loading-container">
    <div class="loading-spinner"></div>
    <p>Loading company details...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error" class="error-container">
    <span class="material-icons error-icon">error_outline</span>
    <p>{{ errorMessage }}</p>
    <button (click)="goBack()" class="btn btn-secondary">
      Back to Companies
    </button>
  </div>

  <!-- Company Details Content -->
  <div class="detail-content" *ngIf="!loading && !error && company">
    <div class="company-card">
      <!-- Basic Information -->
      <div class="detail-section">
        <h2 class="section-title">Basic Information</h2>
        <div class="info-grid">
          <div class="info-item status-item">
            <span class="info-label">Status</span>
            <div class="info-value status-container">
              <span
                class="status-badge"
                [ngClass]="{
                  'status-active': company.status === 'Active',
                  'status-inactive': company.status === 'Inactive'
                }"
              >
                <span class="status-indicator"></span>
                {{ company.status || "Unknown" }}
              </span>
              <button class="status-toggle-btn" (click)="toggleStatus()">
                <span class="material-icons">swap_horiz</span>
                Change status
              </button>
            </div>
          </div>
          <div class="info-item" *ngIf="company.email">
            <span class="info-label">Domain</span>
            <div class="info-value">{{ company.email.split("@")[1] }}</div>
          </div>
          <div class="info-item" *ngIf="company.vatNumber">
            <span class="info-label">VAT Number</span>
            <div class="info-value">{{ company.vatNumber }}</div>
          </div>
        </div>
      </div>

      <!-- Contact Information -->
      <div class="detail-section">
        <h2 class="section-title">Contact Information</h2>
        <div class="info-grid">
          <div class="info-item" *ngIf="company.email">
            <span class="info-label">Email</span>
            <div class="info-value contact-value">
              <span class="material-icons contact-icon">email</span>
              <a [href]="'mailto:' + company.email">{{ company.email }}</a>
            </div>
          </div>
          <div class="info-item" *ngIf="company.phoneNumber">
            <span class="info-label">Phone</span>
            <div class="info-value contact-value">
              <span class="material-icons contact-icon">phone</span>
              <a [href]="'tel:' + company.phoneNumber">{{
                company.phoneNumber
              }}</a>
            </div>
          </div>
          <div class="info-item" *ngIf="company.website">
            <span class="info-label">Website</span>
            <div class="info-value contact-value">
              <span class="material-icons contact-icon">language</span>
              <a
                [href]="company.website"
                target="_blank"
                rel="noopener noreferrer"
                >{{ company.website }}</a
              >
            </div>
          </div>
        </div>
      </div>

      <!-- Address -->
      <div class="detail-section" *ngIf="company.primaryAddress">
        <h2 class="section-title">Address</h2>
        <div class="address-container">
          <div class="address-icon">
            <span class="material-icons">location_on</span>
          </div>
          <div class="address-details">
            <p>{{ company.primaryAddress.line1 }}</p>
            <p *ngIf="company.primaryAddress.line2">
              {{ company.primaryAddress.line2 }}
            </p>
            <p>
              {{ company.primaryAddress.postalCode }}
              {{ company.primaryAddress.city }}
            </p>
            <p>{{ company.primaryAddress.country }}</p>
          </div>
        </div>
      </div>

      <!-- Company Users Section -->
      <div class="detail-section">
        <h2 class="section-title">Company Users</h2>

        <!-- Loading state for users -->
        <div *ngIf="loadingUsers" class="users-loading">
          <div class="mini-spinner"></div>
          <span>Loading users...</span>
        </div>

        <!-- Users table -->
        <div
          *ngIf="!loadingUsers && companyUsers.length > 0"
          class="users-table-container"
        >
          <p class="users-info">
            Users associated with domain
            <strong>{{
              company.email ? "@" + company.email.split("@")[1] : ""
            }}</strong>
          </p>

          <!-- Desktop table view -->
          <table class="users-table desktop-table">
            <thead>
              <tr>
                <th class="user-avatar-col"></th>
                <th class="sortable-column" (click)="sortUsers('name')">
                  Name
                  <span class="material-icons sort-icon">{{
                    getSortIcon("name")
                  }}</span>
                </th>
                <th class="sortable-column" (click)="sortUsers('email')">
                  Email
                  <span class="material-icons sort-icon">{{
                    getSortIcon("email")
                  }}</span>
                </th>
                <th class="sortable-column" (click)="sortUsers('role')">
                  Role
                  <span class="material-icons sort-icon">{{
                    getSortIcon("role")
                  }}</span>
                </th>
                <th class="sortable-column" (click)="sortUsers('status')">
                  Status
                  <span class="material-icons sort-icon">{{
                    getSortIcon("status")
                  }}</span>
                </th>
              </tr>
            </thead>
            <tbody>
              <tr
                *ngFor="let user of companyUsers"
                class="user-row"
                (click)="showUserDetail(user)"
              >
                <td class="user-avatar-col">
                  <div class="user-avatar">
                    {{ user.name.charAt(0).toUpperCase() }}
                  </div>
                </td>
                <td class="user-name">{{ user.name }}</td>
                <td class="user-email">{{ user.email }}</td>
                <td class="user-role">
                  <span [class]="'role-badge ' + getRoleClass(user.role)">
                    {{ formatRole(user.role) }}
                  </span>
                </td>
                <td class="user-status">
                  <span
                    class="status-badge small"
                    [ngClass]="{
                      'status-active':
                        user.status === 'Active' || user.status === 'ACTIVATED',
                      'status-inactive':
                        user.status === 'Inactive' ||
                        user.status === 'DEACTIVATED',
                      'status-pending': user.status === 'PENDING'
                    }"
                  >
                    <span class="status-indicator"></span>
                    {{ user.status }}
                  </span>
                </td>
              </tr>
            </tbody>
          </table>

          <!-- Mobile card view -->
          <div class="mobile-cards-view">
            <div
              *ngFor="let user of companyUsers"
              class="user-card"
              (click)="showUserDetail(user)"
            >
              <div class="user-card-header">
                <div class="user-avatar">
                  {{ user.name.charAt(0).toUpperCase() }}
                </div>
                <div class="user-card-name-email">
                  <div class="user-name">{{ user.name }}</div>
                  <div class="user-email">{{ user.email }}</div>
                </div>
              </div>
              <div class="user-card-footer">
                <span [class]="'role-badge ' + getRoleClass(user.role)">
                  {{ formatRole(user.role) }}
                </span>
                <span
                  class="status-badge small"
                  [ngClass]="{
                    'status-active':
                      user.status === 'Active' || user.status === 'ACTIVATED',
                    'status-inactive':
                      user.status === 'Inactive' ||
                      user.status === 'DEACTIVATED',
                    'status-pending': user.status === 'PENDING'
                  }"
                >
                  <span class="status-indicator"></span>
                  {{ user.status }}
                </span>
              </div>
            </div>
          </div>
        </div>

        <!-- Empty state -->
        <div
          *ngIf="!loadingUsers && companyUsers.length === 0"
          class="no-users"
        >
          <span class="material-icons">person_off</span>
          <p>No users found for this company's domain</p>
        </div>
      </div>

      <!-- System Information -->
      <div class="detail-section">
        <h2 class="section-title">System Information</h2>
        <div class="info-grid">
          <div class="info-item">
            <span class="info-label">Teamleader ID</span>
            <div class="info-value">{{ company.teamleaderId }}</div>
          </div>
          <div class="info-item">
            <span class="info-label">Last Synced</span>
            <div class="info-value">
              {{ company.syncedAt | date : "medium" }}
            </div>
          </div>
          <div class="info-item" *ngIf="company.createdAt">
            <span class="info-label">Created</span>
            <div class="info-value">
              {{ company.createdAt | date : "medium" }}
            </div>
          </div>
          <div class="info-item" *ngIf="company.updatedAt">
            <span class="info-label">Updated</span>
            <div class="info-value">
              {{ company.updatedAt | date : "medium" }}
            </div>
          </div>
        </div>
      </div>

      <!-- Authentication Logs -->
      <div class="auth-logs-section">
        <h4>Recent Authentication Activity</h4>

        <!-- Loading indicator -->
        <div class="auth-logs-loading" *ngIf="loadingAuthLogs">
          <div class="spinner"></div>
          <p>Loading authentication logs...</p>
        </div>

        <!-- Auth logs list -->
        <div
          class="auth-logs-list"
          *ngIf="!loadingAuthLogs && userAuthLogs && userAuthLogs.length > 0"
        >
          <div
            *ngFor="let log of userAuthLogs.slice(0, 5)"
            class="auth-log-item"
          >
            <div class="auth-log-status">
              <span
                class="material-icons"
                [ngClass]="{
                  'success-icon': log.success,
                  'error-icon': !log.success
                }"
              >
                {{ log.success ? "check_circle" : "error" }}
              </span>
            </div>
            <div class="auth-log-details">
              <div class="auth-log-time">
                {{ formatTimestamp(log.timestamp) }}
              </div>
              <div class="auth-log-message">
                {{ log.success ? "Successful login" : "Failed login attempt" }}
                <span *ngIf="log.ipAddress"
                  >&nbsp;from {{ log.ipAddress }}</span
                >
              </div>
            </div>
          </div>
        </div>

        <!-- No logs message -->
        <div
          class="no-logs"
          *ngIf="
            !loadingAuthLogs && (!userAuthLogs || userAuthLogs.length === 0)
          "
        >
          <p>No authentication logs available for this user.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Status Change Confirmation Popup -->
  <div class="status-popup-overlay" *ngIf="showStatusPopup">
    <div class="status-popup">
      <div class="popup-header">
        <span class="material-icons warning-icon">warning</span>
        <h3>Confirm Status Change</h3>
      </div>

      <div class="popup-content">
        <p>
          Are you sure you want to change the status of
          <strong>{{ company?.name }}</strong> from
          <strong>{{ company?.status }}</strong> to
          <strong>{{ newStatus }}</strong
          >?
        </p>

        <div class="status-change-preview">
          <div class="status-from">
            <span
              class="status-badge"
              [ngClass]="{
                'status-active': company?.status === 'Active',
                'status-inactive': company?.status === 'Inactive'
              }"
            >
              <span class="status-indicator"></span>
              {{ company?.status }}
            </span>
          </div>
          <span class="material-icons">arrow_forward</span>
          <div class="status-to">
            <span
              class="status-badge"
              [ngClass]="{
                'status-active': newStatus === 'Active',
                'status-inactive': newStatus === 'Inactive'
              }"
            >
              <span class="status-indicator"></span>
              {{ newStatus }}
            </span>
          </div>
        </div>

        <p class="status-info">
          <span *ngIf="newStatus === 'Inactive'" class="warning-text">
            <span class="material-icons">info</span>
            Inactive companies won't appear in regular searches and may have
            limited functionality.
          </span>
          <span *ngIf="newStatus === 'Active'" class="success-text">
            <span class="material-icons">check_circle</span>
            Active companies have full access to all features and appear in
            regular searches.
          </span>
        </p>
      </div>

      <div class="popup-actions">
        <button
          class="cancel-btn"
          [disabled]="updatingStatus"
          (click)="cancelStatusChange()"
        >
          Cancel
        </button>
        <button
          class="confirm-btn"
          [ngClass]="{
            'confirm-inactive': newStatus === 'Inactive',
            'confirm-active': newStatus === 'Active'
          }"
          [disabled]="updatingStatus"
          (click)="confirmStatusChange()"
        >
          <span *ngIf="updatingStatus" class="mini-spinner"></span>
          <span *ngIf="!updatingStatus">Confirm</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Pending User Actions Popup -->
  <div class="status-popup-overlay" *ngIf="showPendingPopup">
    <div class="pending-popup">
      <div class="popup-header">
        <span class="material-icons">person_add</span>
        <h3>Pending User Request</h3>
      </div>

      <div class="popup-content" *ngIf="selectedPendingUser">
        <div class="pending-user-details">
          <p class="pending-detail-item">
            <span class="detail-label">Name:</span>
            <span class="detail-value">{{ selectedPendingUser.name }}</span>
          </p>
          <p class="pending-detail-item">
            <span class="detail-label">Email:</span>
            <span class="detail-value">{{ selectedPendingUser.email }}</span>
          </p>
          <p class="pending-detail-item">
            <span class="detail-label">Requested:</span>
            <span class="detail-value">{{
              selectedPendingUser.requestedAt | date : "medium"
            }}</span>
          </p>
        </div>

        <p class="pending-actions-prompt">
          How would you like to proceed with this user request?
        </p>
      </div>

      <div class="popup-actions">
        <button
          class="reject-btn"
          (click)="rejectUser(selectedPendingUser?.id || '')"
        >
          <span class="material-icons">close</span>
          Reject
        </button>
        <button
          class="approve-btn"
          (click)="approveUser(selectedPendingUser?.id || '')"
        >
          <span class="material-icons">check</span>
          Approve
        </button>
      </div>
    </div>
  </div>

  <!-- Pending User Confirmation Popup -->
  <div class="status-popup-overlay" *ngIf="showUserActionConfirmPopup">
    <div class="pending-popup">
      <div
        class="popup-header"
        [ngClass]="{
          'approve-header': confirmAction === 'approve',
          'reject-header': confirmAction === 'reject'
        }"
      >
        <span class="material-icons">{{
          confirmAction === "approve" ? "check_circle" : "error"
        }}</span>
        <h3>
          Confirm {{ confirmAction === "approve" ? "Approval" : "Rejection" }}
        </h3>
      </div>

      <div class="popup-content" *ngIf="selectedPendingUser">
        <p>
          Are you sure you want to
          <strong>{{
            confirmAction === "approve" ? "approve" : "reject"
          }}</strong>
          this user request?
        </p>

        <div class="pending-user-details">
          <p class="pending-detail-item">
            <span class="detail-label">Name:</span>
            <span class="detail-value">{{ selectedPendingUser.name }}</span>
          </p>
          <p class="pending-detail-item">
            <span class="detail-label">Email:</span>
            <span class="detail-value">{{ selectedPendingUser.email }}</span>
          </p>
          <p class="pending-detail-item">
            <span class="detail-label">Requested:</span>
            <span class="detail-value">{{
              formatTimeAgo(selectedPendingUser.requestedAt)
            }}</span>
          </p>
        </div>

        <div class="status-info">
          <div *ngIf="confirmAction === 'approve'" class="success-text">
            <span class="material-icons">info</span>
            <span
              >The user will be granted access to the system and appear in the
              company users list.</span
            >
          </div>
          <div *ngIf="confirmAction === 'reject'" class="warning-text">
            <span class="material-icons">info</span>
            <span
              >The user's request will be denied and they will need to request
              access again if needed.</span
            >
          </div>
        </div>
      </div>

      <div class="popup-actions">
        <button class="cancel-btn" (click)="cancelUserAction()">
          <span class="material-icons">close</span>
          Cancel
        </button>
        <button
          *ngIf="confirmAction === 'approve'"
          class="approve-btn"
          (click)="confirmUserAction()"
        >
          <span class="material-icons">check</span>
          Approve
        </button>
        <button
          *ngIf="confirmAction === 'reject'"
          class="reject-btn"
          (click)="confirmUserAction()"
        >
          <span class="material-icons">block</span>
          Reject
        </button>
      </div>
    </div>
  </div>

  <!-- Add the User Detail Popup HTML -->
  <!-- User Detail Popup -->
  <div
    class="user-detail-popup-overlay"
    *ngIf="showUserDetailPopup && selectedUser"
  >
    <div class="user-detail-popup">
      <div class="popup-header">
        <div class="user-detail-avatar">
          {{ selectedUser.name.charAt(0).toUpperCase() }}
        </div>
        <h3>User Details</h3>
        <button class="close-button" (click)="hideUserDetail()">
          <span class="material-icons">close</span>
        </button>
      </div>

      <div class="popup-content">
        <!-- Basic User Information -->
        <div class="user-info-section">
          <h4>Information</h4>
          <div class="user-info-grid">
            <div class="info-item">
              <span class="info-label">Name</span>
              <div class="info-value">{{ selectedUser.name }}</div>
            </div>
            <div class="info-item">
              <span class="info-label">Email</span>
              <div class="info-value">{{ selectedUser.email }}</div>
            </div>
            <div class="info-item">
              <span class="info-label">ID</span>
              <div class="info-value">{{ selectedUser.id }}</div>
            </div>
            <div class="info-item">
              <span class="info-label">Last Login</span>
              <div class="info-value">
                {{
                  selectedUser.lastLogin
                    ? formatTimestamp(selectedUser.lastLogin)
                    : "Never"
                }}
              </div>
            </div>
          </div>
        </div>

        <!-- Role Management -->
        <div class="user-role-section">
          <h4>Role</h4>
          <div class="role-controls">
            <div class="role-display">
              <span class="info-label">Current Role</span>
              <span [class]="'role-badge ' + getRoleClass(selectedUser.role)">
                {{ formatRole(selectedUser.role) }}
              </span>
            </div>
            <div class="role-selector">
              <span class="info-label">Change Role</span>
              <div class="role-buttons">
                <button
                  *ngFor="let role of availableRoles"
                  [class]="'role-option-btn ' + getRoleClass(role)"
                  [disabled]="updatingUser || selectedUser.role === role"
                  (click)="updateUserRole(role)"
                >
                  {{ formatRole(role) }}
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Status Management -->
        <div class="user-status-section">
          <h4>Status</h4>
          <div class="status-controls">
            <div class="status-display">
              <span class="info-label">Current Status</span>
              <span
                class="status-badge"
                [ngClass]="{
                  'status-active': selectedUser.status === 'Active',
                  'status-inactive': selectedUser.status === 'Inactive'
                }"
              >
                <span class="status-indicator"></span>
                {{ selectedUser.status }}
              </span>
            </div>
            <div class="status-selector">
              <span class="info-label">Change Status</span>
              <div class="status-buttons">
                <button
                  *ngFor="let status of availableStatuses"
                  [class]="
                    'status-option-btn ' +
                    (status === 'Active' ? 'active-btn' : 'inactive-btn')
                  "
                  [disabled]="updatingUser || selectedUser.status === status"
                  (click)="updateUserStatus(status)"
                >
                  {{ status }}
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Authentication Logs -->
        <div class="auth-logs-section">
          <h4>Recent Authentication Activity</h4>
          <div
            class="auth-logs-list"
            *ngIf="userAuthLogs && userAuthLogs.length > 0"
          >
            <div
              *ngFor="let log of userAuthLogs.slice(0, 5)"
              class="auth-log-item"
            >
              <div class="auth-log-status">
                <span
                  class="material-icons"
                  [ngClass]="{
                    'success-icon': log.success,
                    'error-icon': !log.success
                  }"
                >
                  {{ log.success ? "check_circle" : "error" }}
                </span>
              </div>
              <div class="auth-log-details">
                <div class="auth-log-time">
                  {{ formatTimestamp(log.timestamp) }}
                </div>
                <div class="auth-log-message">
                  {{
                    log.success ? "Successful login" : "Failed login attempt"
                  }}
                  <span *ngIf="log.ipAddress"
                    >&nbsp;from {{ log.ipAddress }}</span
                  >
                </div>
              </div>
            </div>
          </div>
          <div
            class="no-logs"
            *ngIf="!userAuthLogs || userAuthLogs.length === 0"
          >
            <p>No authentication logs available for this user.</p>
          </div>
        </div>
      </div>

      <div class="popup-footer">
        <button class="btn btn-secondary" (click)="hideUserDetail()">
          Close
        </button>
      </div>
    </div>
  </div>

  <!-- Show loading indicator when updating user -->
  <div class="updating-overlay" *ngIf="updatingUser">
    <div class="spinner"></div>
    <p>Updating user...</p>
  </div>
</div>
