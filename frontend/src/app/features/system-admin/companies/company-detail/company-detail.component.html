<div class="company-detail-container">
  <!-- Back button and header -->
  <div class="detail-header">
    <button class="back-button" (click)="goBack()">
      <span class="material-icons">arrow_back</span>
      Back to Companies
    </button>
    <div class="header-content">
      <h1 class="company-name" *ngIf="company">{{ company.name }}</h1>

      <!-- Notification bell with popup -->
      <div class="notification-container" *ngIf="hasPendingUsers">
        <button
          class="notification-bell"
          title="Pending account requests"
          (click)="toggleNotificationPopup($event)"
          aria-label="Show pending account requests"
        >
          <span class="material-icons">notifications_active</span>
          <span class="notification-count">{{ pendingCount }}</span>
        </button>

        <!-- Notification Popup -->
        <div class="notification-popup" *ngIf="showNotificationPopup">
          <div class="notification-header">
            <h3>Pending Account Requests</h3>
            <span class="notification-count-badge">{{ pendingCount }}</span>
          </div>

          <div class="notification-content">
            <div class="notification-item" *ngFor="let user of pendingUsers">
              <div class="notification-user-avatar">
                {{ user.name.charAt(0).toUpperCase() }}
              </div>
              <div class="notification-user-info">
                <div class="notification-user-name">{{ user.name }}</div>
                <div class="notification-user-email" title="{{ user.email }}">
                  {{ user.email }}
                </div>
                <div class="notification-time">
                  {{ formatTimeAgo(user.requestedAt) }}
                </div>
              </div>
              <div class="notification-actions">
                <button
                  class="action-btn reject-btn"
                  (click)="rejectUser(user.id)"
                  title="Reject user"
                  aria-label="Reject user request"
                >
                  <span class="material-icons">close</span>
                </button>
                <button
                  class="action-btn approve-btn"
                  (click)="approveUser(user.id)"
                  title="Approve user"
                  aria-label="Approve user request"
                >
                  <span class="material-icons">check</span>
                </button>
              </div>
            </div>

            <!-- Empty state when there are no pending requests -->
            <div class="empty-notification" *ngIf="pendingUsers.length === 0">
              <span class="material-icons">done_all</span>
              <p>All account requests have been processed</p>
              <small>Check back later for new requests</small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="loading-container">
    <div class="loading-spinner"></div>
    <p>Loading company details...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error" class="error-container">
    <span class="material-icons error-icon">error_outline</span>
    <p>{{ errorMessage }}</p>
    <button (click)="goBack()" class="btn btn-secondary">
      Back to Companies
    </button>
  </div>

  <!-- Company Details Content -->
  <div class="detail-content" *ngIf="!loading && !error && company">
    <div class="company-card">
      <!-- Basic Information -->
      <div class="detail-section">
        <h2 class="section-title">Basic Information</h2>
        <div class="info-grid">
          <div class="info-item status-item">
            <span class="info-label">Status</span>
            <div class="info-value status-container">
              <span
                class="status-badge"
                [ngClass]="{
                  'status-active': company.status === 'Active',
                  'status-inactive': company.status === 'Inactive'
                }"
              >
                <span class="status-indicator"></span>
                {{ company.status || "Unknown" }}
              </span>
              <button class="status-toggle-btn" (click)="toggleStatus()">
                <span class="material-icons">swap_horiz</span>
                Change status
              </button>
            </div>
          </div>
          <div class="info-item" *ngIf="company.email">
            <span class="info-label">Domain</span>
            <div class="info-value">{{ company.email.split("@")[1] }}</div>
          </div>
          <div class="info-item" *ngIf="company.vatNumber">
            <span class="info-label">VAT Number</span>
            <div class="info-value">{{ company.vatNumber }}</div>
          </div>
        </div>
      </div>

      <!-- Contact Information -->
      <div class="detail-section">
        <h2 class="section-title">Contact Information</h2>
        <div class="info-grid">
          <div class="info-item" *ngIf="company.email">
            <span class="info-label">Email</span>
            <div class="info-value contact-value">
              <span class="material-icons contact-icon">email</span>
              <a [href]="'mailto:' + company.email">{{ company.email }}</a>
            </div>
          </div>
          <div class="info-item" *ngIf="company.phoneNumber">
            <span class="info-label">Phone</span>
            <div class="info-value contact-value">
              <span class="material-icons contact-icon">phone</span>
              <a [href]="'tel:' + company.phoneNumber">{{
                company.phoneNumber
              }}</a>
            </div>
          </div>
          <div class="info-item" *ngIf="company.website">
            <span class="info-label">Website</span>
            <div class="info-value contact-value">
              <span class="material-icons contact-icon">language</span>
              <a
                [href]="company.website"
                target="_blank"
                rel="noopener noreferrer"
                >{{ company.website }}</a
              >
            </div>
          </div>
        </div>
      </div>

      <!-- Address -->
      <div class="detail-section" *ngIf="company.primaryAddress">
        <h2 class="section-title">Address</h2>
        <div class="address-container">
          <div class="address-icon">
            <span class="material-icons">location_on</span>
          </div>
          <div class="address-details">
            <p>{{ company.primaryAddress.line1 }}</p>
            <p *ngIf="company.primaryAddress.line2">
              {{ company.primaryAddress.line2 }}
            </p>
            <p>
              {{ company.primaryAddress.postalCode }}
              {{ company.primaryAddress.city }}
            </p>
            <p>{{ company.primaryAddress.country }}</p>
          </div>
        </div>
      </div>

      <!-- Company Users Section -->
      <div class="detail-section">
        <h2 class="section-title">Company Users</h2>

        <!-- Loading state for users -->
        <div *ngIf="loadingUsers" class="users-loading">
          <div class="mini-spinner"></div>
          <span>Loading users...</span>
        </div>

        <!-- Users table -->
        <div
          *ngIf="!loadingUsers && companyUsers.length > 0"
          class="users-table-container"
        >
          <p class="users-info">
            Users associated with domain
            <strong>{{
              company.email ? "@" + company.email.split("@")[1] : ""
            }}</strong>
          </p>

          <!-- Desktop table view -->
          <table class="users-table desktop-table">
            <thead>
              <tr>
                <th class="user-avatar-col"></th>
                <th class="sortable-column" (click)="sortUsers('name')">
                  Name
                  <span class="material-icons sort-icon">{{
                    getSortIcon("name")
                  }}</span>
                </th>
                <th class="sortable-column" (click)="sortUsers('email')">
                  Email
                  <span class="material-icons sort-icon">{{
                    getSortIcon("email")
                  }}</span>
                </th>
                <th class="sortable-column" (click)="sortUsers('role')">
                  Role
                  <span class="material-icons sort-icon">{{
                    getSortIcon("role")
                  }}</span>
                </th>
                <th class="sortable-column" (click)="sortUsers('status')">
                  Status
                  <span class="material-icons sort-icon">{{
                    getSortIcon("status")
                  }}</span>
                </th>
              </tr>
            </thead>
            <tbody>
              <tr
                *ngFor="let user of companyUsers"
                class="user-row"
                (click)="showUserDetail(user)"
              >
                <td class="user-avatar-col">
                  <div class="user-avatar">
                    {{ user.name.charAt(0).toUpperCase() }}
                  </div>
                </td>
                <td class="user-name">{{ user.name }}</td>
                <td class="user-email">{{ user.email }}</td>
                <td class="user-role">
                  <span [class]="getRoleClass(user.role)">{{
                    formatRole(user.role)
                  }}</span>
                </td>
                <td class="user-status">
                  <span
                    class="status-badge small"
                    [ngClass]="{
                      'status-active':
                        user.status === 'Active' || user.status === 'ACTIVATED',
                      'status-inactive':
                        user.status === 'Inactive' ||
                        user.status === 'DEACTIVATED',
                      'status-pending': user.status === 'PENDING'
                    }"
                  >
                    <span class="status-indicator"></span>
                    {{ user.status }}
                  </span>
                </td>
              </tr>
            </tbody>
          </table>

          <!-- Mobile card view -->
          <div class="mobile-cards-view">
            <div
              *ngFor="let user of companyUsers"
              class="user-card"
              (click)="showUserDetail(user)"
            >
              <div class="user-card-header">
                <div class="user-avatar">
                  {{ user.name.charAt(0).toUpperCase() }}
                </div>
                <div class="user-card-name-email">
                  <div class="user-name">{{ user.name }}</div>
                  <div class="user-email">{{ user.email }}</div>
                </div>
              </div>
              <div class="user-card-footer">
                <span [class]="getRoleClass(user.role)">{{
                  formatRole(user.role)
                }}</span>
                <span
                  class="status-badge small"
                  [ngClass]="{
                    'status-active':
                      user.status === 'Active' || user.status === 'ACTIVATED',
                    'status-inactive':
                      user.status === 'Inactive' ||
                      user.status === 'DEACTIVATED',
                    'status-pending': user.status === 'PENDING'
                  }"
                >
                  <span class="status-indicator"></span>
                  {{ user.status }}
                </span>
              </div>
            </div>
          </div>
        </div>

        <!-- Empty state -->
        <div
          *ngIf="!loadingUsers && companyUsers.length === 0"
          class="no-users"
        >
          <span class="material-icons">person_off</span>
          <p>No users found for this company's domain</p>
        </div>
      </div>

      <!-- System Information -->
      <div class="detail-section">
        <h2 class="section-title">System Information</h2>
        <div class="info-grid">
          <div class="info-item">
            <span class="info-label">Teamleader ID</span>
            <div class="info-value">{{ company.teamleaderId }}</div>
          </div>
          <div class="info-item">
            <span class="info-label">Last Synced</span>
            <div class="info-value">
              {{ company.syncedAt | date : "medium" }}
            </div>
          </div>
          <div class="info-item" *ngIf="company.createdAt">
            <span class="info-label">Created</span>
            <div class="info-value">
              {{ company.createdAt | date : "medium" }}
            </div>
          </div>
          <div class="info-item" *ngIf="company.updatedAt">
            <span class="info-label">Updated</span>
            <div class="info-value">
              {{ company.updatedAt | date : "medium" }}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Status Change Confirmation Popup -->
  <div
    class="status-popup-overlay"
    *ngIf="showStatusPopup"
    (click)="cancelStatusChange()"
    aria-modal="true"
    role="dialog"
  >
    <div class="status-popup" (click)="$event.stopPropagation()">
      <div class="popup-header">
        <span class="material-icons warning-icon">warning</span>
        <h3 id="status-popup-title">Confirm Status Change</h3>
      </div>

      <div class="popup-content">
        <p>
          Are you sure you want to change the status of
          <strong>{{ company?.name }}</strong> from
          <strong>{{ company?.status }}</strong> to
          <strong>{{ newStatus }}</strong
          >?
        </p>

        <div class="status-change-preview">
          <div class="status-from" data-label="Current">
            <span
              class="status-badge"
              [ngClass]="{
                'status-active': company?.status === 'Active',
                'status-inactive': company?.status === 'Inactive'
              }"
            >
              <span class="status-indicator"></span>
              {{ company?.status }}
            </span>
          </div>
          <span class="material-icons">arrow_forward</span>
          <div class="status-to" data-label="New">
            <span
              class="status-badge"
              [ngClass]="{
                'status-active': newStatus === 'Active',
                'status-inactive': newStatus === 'Inactive'
              }"
            >
              <span class="status-indicator"></span>
              {{ newStatus }}
            </span>
          </div>
        </div>

        <div *ngIf="newStatus === 'Inactive'" class="status-info warning-text">
          <span class="material-icons">info</span>
          <span
            >Inactive companies won't appear in regular searches and may have
            limited functionality.</span
          >
        </div>
        <div *ngIf="newStatus === 'Active'" class="status-info success-text">
          <span class="material-icons">check_circle</span>
          <span
            >Active companies have full access to all features and appear in
            regular searches.</span
          >
        </div>
      </div>

      <div class="popup-actions">
        <button
          class="cancel-btn"
          [disabled]="updatingStatus"
          (click)="cancelStatusChange()"
        >
          Cancel
        </button>
        <button
          class="confirm-btn"
          [ngClass]="{
            'confirm-inactive': newStatus === 'Inactive',
            'confirm-active': newStatus === 'Active'
          }"
          [disabled]="updatingStatus"
          (click)="confirmStatusChange()"
        >
          <span *ngIf="updatingStatus" class="mini-spinner"></span>
          <span *ngIf="!updatingStatus">Confirm</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Pending User Actions Popup -->
  <div
    class="status-popup-overlay"
    *ngIf="showPendingPopup"
    (click)="hidePendingPopup()"
    aria-modal="true"
    role="dialog"
  >
    <div class="pending-popup" (click)="$event.stopPropagation()">
      <div class="popup-header">
        <span class="material-icons">person_add</span>
        <h3>Account Request</h3>
      </div>

      <div class="popup-content" *ngIf="selectedPendingUser">
        <div class="pending-user-avatar">
          {{ selectedPendingUser.name.charAt(0).toUpperCase() }}
        </div>

        <h4 class="pending-user-title">{{ selectedPendingUser.name }}</h4>

        <div class="pending-user-details">
          <div class="pending-detail-item">
            <span class="material-icons">email</span>
            <span class="detail-value">{{ selectedPendingUser.email }}</span>
          </div>
          <div class="pending-detail-item">
            <span class="material-icons">schedule</span>
            <span class="detail-value"
              >Requested
              {{ formatTimeAgo(selectedPendingUser.requestedAt) }}</span
            >
          </div>
        </div>

        <div class="pending-actions-prompt">
          <span class="material-icons">help_outline</span>
          <p>How would you like to proceed with this request?</p>
        </div>
      </div>

      <div class="popup-actions">
        <button class="cancel-btn" (click)="hidePendingPopup()">
          <span class="material-icons">arrow_back</span>
          Back
        </button>
        <div class="decision-buttons">
          <button
            class="reject-btn"
            (click)="rejectUser(selectedPendingUser?.id || '')"
          >
            <span class="material-icons">close</span>
            Reject
          </button>
          <button
            class="approve-btn"
            (click)="approveUser(selectedPendingUser?.id || '')"
          >
            <span class="material-icons">check</span>
            Approve
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Pending User Confirmation Popup -->
  <div
    class="status-popup-overlay"
    *ngIf="showUserActionConfirmPopup"
    (click)="cancelUserAction()"
    aria-modal="true"
    role="dialog"
  >
    <div
      class="pending-popup user-action-confirm"
      (click)="$event.stopPropagation()"
    >
      <div
        class="popup-header"
        [ngClass]="{
          'approve-header': confirmAction === 'approve',
          'reject-header': confirmAction === 'reject'
        }"
      >
        <span class="material-icons">{{
          confirmAction === "approve" ? "check_circle" : "error"
        }}</span>
        <h3>
          Confirm {{ confirmAction === "approve" ? "Approval" : "Rejection" }}
        </h3>
      </div>

      <div class="popup-content" *ngIf="selectedPendingUser">
        <p class="confirmation-text">
          Are you sure you want to
          <span class="reject" *ngIf="confirmAction === 'reject'">reject</span
          ><span *ngIf="confirmAction === 'approve'">approve</span> this user
          request?
        </p>

        <div class="pending-user-details">
          <div class="pending-detail-item">
            <span class="material-icons">person</span>
            <span class="detail-value">{{ selectedPendingUser.name }}</span>
          </div>
          <div class="pending-detail-item">
            <span class="material-icons">email</span>
            <span class="detail-value">{{ selectedPendingUser.email }}</span>
          </div>
          <div class="pending-detail-item">
            <span class="material-icons">schedule</span>
            <span class="detail-value"
              >Requested
              {{ formatTimeAgo(selectedPendingUser.requestedAt) }}</span
            >
          </div>
        </div>

        <div
          class="confirmation-info"
          [ngClass]="{
            'success-info': confirmAction === 'approve',
            'warning-info': confirmAction === 'reject'
          }"
        >
          <span class="material-icons">{{
            confirmAction === "approve" ? "info" : "warning"
          }}</span>
          <span *ngIf="confirmAction === 'approve'"
            >The user will be granted access to the system and appear in the
            company users list.</span
          >
          <span *ngIf="confirmAction === 'reject'"
            >The user's request will be denied and they will need to request
            access again if needed.</span
          >
        </div>

        <div class="popup-actions">
          <button
            *ngIf="confirmAction === 'approve'"
            class="approve-btn"
            (click)="confirmUserAction()"
            (touchstart)="confirmUserAction()"
            role="button"
            tabindex="0"
            aria-label="Approve user"
          >
            <span class="material-icons">check</span>
            Approve
          </button>
          <button
            *ngIf="confirmAction === 'reject'"
            class="reject-btn"
            (click)="confirmUserAction()"
            (touchstart)="confirmUserAction()"
            role="button"
            tabindex="0"
            aria-label="Reject user"
          >
            <span class="material-icons">block</span>
            Reject
          </button>
          <button
            class="cancel-btn"
            (click)="cancelUserAction()"
            (touchstart)="cancelUserAction()"
            role="button"
            tabindex="0"
            aria-label="Cancel"
          >
            Cancel
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- User Detail Popup -->
  <div
    class="user-detail-popup-overlay"
    *ngIf="showUserDetailPopup && selectedUser"
    (click)="hideUserDetail()"
    aria-modal="true"
    role="dialog"
    tabindex="-1"
    aria-labelledby="user-detail-title"
  >
    <div class="user-detail-popup" (click)="$event.stopPropagation()">
      <!-- Header -->
      <div class="popup-header">
        <div class="user-detail-avatar">
          {{ selectedUser.name.charAt(0).toUpperCase() }}
        </div>
        <div class="header-content">
          <h3 id="user-detail-title">{{ selectedUser.name }}</h3>
          <div class="user-meta">
            <span class="user-email">{{ selectedUser.email }}</span>
          </div>
        </div>
        <button
          class="close-button"
          (click)="hideUserDetail()"
          aria-label="Close user details"
        >
          <span class="material-icons">close</span>
        </button>
      </div>

      <div class="popup-content">
        <!-- User Information Section -->
        <div class="detail-section">
          <h4 class="section-title">User Information</h4>
          <div class="info-grid">
            <div class="info-item">
              <span class="info-label">User ID</span>
              <div class="info-value monospace">
                {{ selectedUser.id }}
                <button
                  class="copy-btn"
                  title="Copy ID to clipboard"
                  (click)="copyToClipboard(selectedUser.id)"
                >
                  <span class="material-icons">content_copy</span>
                </button>
              </div>
            </div>

            <div class="info-item">
              <span class="info-label">Last Login</span>
              <div class="info-value">
                {{
                  selectedUser.lastLogin
                    ? (selectedUser.lastLogin | date : "MMM d, y, h:mm a")
                    : "Never logged in"
                }}
              </div>
            </div>

            <div class="info-item">
              <span class="info-label">Current Role</span>
              <div class="info-value">
                <span [class]="getRoleClass(selectedUser.role)">{{
                  formatRole(selectedUser.role)
                }}</span>
              </div>
            </div>

            <div class="info-item">
              <span class="info-label">Current Status</span>
              <div class="info-value">
                <span
                  class="status-badge"
                  [ngClass]="{
                    'status-active': selectedUser.status === 'Active',
                    'status-inactive': selectedUser.status === 'Inactive'
                  }"
                >
                  <span class="status-indicator"></span>
                  {{ selectedUser.status }}
                </span>
              </div>
            </div>
          </div>
        </div>

        <!-- Role Management Section - Only hide for system admins -->
        <div class="detail-section" *ngIf="!isSystemAdmin(selectedUser.role)">
          <h4 class="section-title">Change Role</h4>
          <div class="action-buttons role-buttons">
            <button
              *ngFor="let role of availableRoles"
              class="action-button role-button"
              [ngClass]="[
                getRoleClass(role),
                selectedUser.role === role ? 'selected' : ''
              ]"
              [disabled]="updatingUser || selectedUser.role === role"
              (click)="updateUserRole(role)"
            >
              <span
                class="material-icons"
                *ngIf="role.toUpperCase().includes('ADMIN')"
                >admin_panel_settings</span
              >
              <span
                class="material-icons"
                *ngIf="!role.toUpperCase().includes('ADMIN')"
                >person</span
              >
              {{ formatRole(role) }}
            </button>
          </div>
          <p class="helper-text" *ngIf="!isUserAdmin(selectedUser.role)">
            You can set this user to a regular user role
          </p>
          <p
            class="helper-text"
            *ngIf="
              isUserAdmin(selectedUser.role) &&
              !isSystemAdmin(selectedUser.role)
            "
          >
            You can change this admin to a regular user
          </p>
        </div>

        <!-- Status Management Section -->
        <div class="detail-section">
          <h4 class="section-title">Change Status</h4>
          <div class="action-buttons status-buttons">
            <button
              *ngFor="let status of availableStatuses"
              class="action-button status-button"
              [ngClass]="[
                status === 'Active' ? 'active-btn' : 'inactive-btn',
                selectedUser.status === status ? 'selected' : ''
              ]"
              [disabled]="updatingUser || selectedUser.status === status"
              (click)="updateUserStatus(status)"
            >
              <span class="material-icons">
                {{ status === "Active" ? "check_circle" : "cancel" }}
              </span>
              {{ status }}
            </button>
          </div>
          <p class="helper-text">
            <span *ngIf="selectedUser.status === 'Active'">
              Set to <strong>Inactive</strong> to disable the user's account
            </span>
            <span *ngIf="selectedUser.status === 'Inactive'">
              Set to <strong>Active</strong> to enable the user's account
            </span>
          </p>
        </div>
      </div>

      <div class="popup-footer">
        <div class="footer-note">
          <span class="material-icons info-icon">info</span>
          <span>Changes are applied immediately</span>
        </div>
        <button class="close-btn" (click)="hideUserDetail()">Close</button>
      </div>
    </div>
  </div>

  <!-- Show loading indicator when updating user -->
  <div class="updating-overlay" *ngIf="updatingUser">
    <div class="spinner-container">
      <div class="spinner"></div>
      <p>Updating user...</p>
    </div>
  </div>
</div>
