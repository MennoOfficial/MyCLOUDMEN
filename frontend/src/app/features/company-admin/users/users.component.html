<!-- Users Page - Standardized Components -->
<div class="page-container">
  <!-- Page Header -->
  <app-page-header
    title="Users"
    subtitle="Manage company users and their permissions"
    [actions]="headerActions"
    (actionClick)="onHeaderAction($event)"
  ></app-page-header>

  <!-- Notification Bell for Pending Users -->
  <div *ngIf="hasPendingUsers" class="notification-section">
    <div class="notification-bell" (click)="toggleNotificationPopup($event)">
      <span class="material-icons">notifications</span>
      <span class="notification-count">{{ pendingCount }}</span>
    </div>

    <!-- Notification Popup -->
    <div *ngIf="showNotificationPopup" class="notification-popup">
      <div class="notification-header">
        <h3>Pending User Requests</h3>
        <span class="pending-count">{{ pendingCount }} pending</span>
      </div>
      <div class="notification-body">
        <div
          *ngFor="let user of pendingUsers"
          class="pending-user-item"
          (click)="showPendingUserActions(user)"
        >
          <div class="user-info">
            <div class="user-avatar">
              <img
                *ngIf="user.picture"
                [src]="user.picture"
                [alt]="user.name"
              />
              <span *ngIf="!user.picture">{{
                user.name.charAt(0).toUpperCase()
              }}</span>
            </div>
            <div class="user-details">
              <div class="user-name">{{ user.name }}</div>
              <div class="user-email">{{ user.email }}</div>
              <div class="request-time">
                {{ formatTimeAgo(user.requestedAt) }}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Search and Filter -->
  <app-search-filter
    searchPlaceholder="Search users..."
    [filterConfigs]="filterConfigs"
    (searchFilter)="onSearchFilter($event)"
  ></app-search-filter>

  <!-- Users Data Table -->
  <app-data-table
    *ngIf="!loadingUsers && !error"
    [data]="filteredUsers"
    [columns]="tableColumns"
    [tableActions]="tableActions"
    [loading]="loadingUsers"
    [rowClickable]="true"
    [showPagination]="false"
    [sortColumn]="sortColumn"
    [sortDirection]="sortDirection"
    emptyIcon="person_off"
    emptyTitle="No users found"
    emptyMessage="No users found for this company's domain"
    (sort)="onSort($event)"
    (rowClick)="onRowClick($event)"
    (action)="onTableAction($event)"
  ></app-data-table>

  <!-- Loading State -->
  <div *ngIf="loadingUsers" class="loading-container">
    <div class="loading-spinner"></div>
    <p>Loading users...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error" class="error-container">
    <span class="material-icons error-icon">error</span>
    <p>{{ errorMessage }}</p>
    <button class="btn btn-primary" (click)="fetchCompanyUsers()">
      Try Again
    </button>
  </div>
</div>

<!-- Keep existing popups and modals -->
<!-- Pending User Actions Popup -->
<div *ngIf="showPendingPopup" class="popup-overlay">
  <div class="pending-requests-popup">
    <div class="popup-header">
      <h3>User Request</h3>
      <button class="close-btn" (click)="hidePendingPopup()">
        <span class="material-icons">close</span>
      </button>
    </div>

    <div class="popup-body" *ngIf="selectedPendingUser">
      <div class="user-profile">
        <div class="user-avatar-large">
          <img
            *ngIf="selectedPendingUser.picture"
            [src]="selectedPendingUser.picture"
            [alt]="selectedPendingUser.name"
          />
          <span *ngIf="!selectedPendingUser.picture">{{
            selectedPendingUser.name.charAt(0).toUpperCase()
          }}</span>
        </div>
        <div class="user-info">
          <h4>{{ selectedPendingUser.name }}</h4>
          <p class="user-email">{{ selectedPendingUser.email }}</p>
          <p class="request-time">
            Requested {{ formatTimeAgo(selectedPendingUser.requestedAt) }}
          </p>
        </div>
      </div>

      <div class="action-buttons">
        <button
          class="btn btn-success"
          (click)="approveUser(selectedPendingUser.id)"
        >
          <span class="material-icons">check</span>
          Approve
        </button>
        <button
          class="btn btn-danger"
          (click)="rejectUser(selectedPendingUser.id)"
        >
          <span class="material-icons">close</span>
          Reject
        </button>
      </div>
    </div>
  </div>
</div>

<!-- User Action Confirmation Popup -->
<div *ngIf="showUserActionConfirmPopup" class="popup-overlay">
  <div class="confirmation-popup">
    <div class="popup-header">
      <h3>
        Confirm {{ confirmAction === "approve" ? "Approval" : "Rejection" }}
      </h3>
    </div>

    <div class="popup-body">
      <p>Are you sure you want to {{ confirmAction }} this user request?</p>

      <div class="action-buttons">
        <button
          class="btn"
          [ngClass]="confirmAction === 'approve' ? 'btn-success' : 'btn-danger'"
          (click)="confirmUserAction()"
        >
          Yes, {{ confirmAction === "approve" ? "Approve" : "Reject" }}
        </button>
        <button class="btn btn-ghost" (click)="cancelUserAction()">
          Cancel
        </button>
      </div>
    </div>
  </div>
</div>

<!-- User Detail Modal -->
<app-user-detail-modal
  [isOpen]="showUserDetailPopup"
  [user]="selectedUserForModal"
  [isUpdating]="updatingUser"
  (modalClose)="hideUserDetail()"
  (userUpdate)="onUserUpdate($event)"
  (copyEmail)="copyToClipboard($event)"
></app-user-detail-modal>

<!-- Toast Notifications -->
<div
  *ngIf="showToast"
  class="toast-notification"
  [ngClass]="'toast-' + toastType"
>
  <span class="material-icons">
    {{ toastType === "success" ? "check_circle" : "error" }}
  </span>
  <span>{{ toastMessage }}</span>
</div>
