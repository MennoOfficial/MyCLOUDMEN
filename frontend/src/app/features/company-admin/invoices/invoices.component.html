<!-- Invoices Page - Cloudmen Design System Implementation -->
<div class="page-container" [class.has-detail-open]="isDetailViewVisible">
  <!-- Page Header -->
  <div class="page-header" [class.dimmed]="isDetailViewVisible">
    <h2>Invoices</h2>
  </div>

  <!-- Tab navigation -->
  <div class="tab-navigation" [class.dimmed]="isDetailViewVisible">
    <button
      class="tab-button"
      [class.active]="activeTab === 'outstanding'"
      (click)="switchTab('outstanding')"
    >
      Outstanding
    </button>
    <button
      class="tab-button"
      [class.active]="activeTab === 'paid'"
      (click)="switchTab('paid')"
    >
      Paid
    </button>
  </div>

  <!-- Search and Filter Controls -->
  <div class="search-filter-container" [class.dimmed]="isDetailViewVisible">
    <div class="search-box">
      <i class="material-icons search-icon">search</i>
      <input
        type="text"
        placeholder="Search invoices..."
        [(ngModel)]="searchText"
        (input)="applyFilters()"
      />
      <button *ngIf="searchText" class="clear-search" (click)="clearSearch()">
        <i class="material-icons">close</i>
      </button>
    </div>

    <div class="filters-group">
      <div class="filters">
        <div class="filter-select">
          <select
            id="date-filter"
            [(ngModel)]="dateRangeFilter"
            (change)="applyFilters()"
          >
            <option value="all">All Dates</option>
            <option value="last7">Last 7 days</option>
            <option value="last30">Last 30 days</option>
            <option value="last90">Last 90 days</option>
            <option value="custom">Custom Range</option>
          </select>
        </div>
        <div class="filter-select">
          <select
            id="amount-filter"
            [(ngModel)]="amountRangeFilter"
            (change)="applyFilters()"
          >
            <option value="all">All Amounts</option>
            <option value="under500">Under €500</option>
            <option value="500to1000">€500 - €1,000</option>
            <option value="1000to5000">€1,000 - €5,000</option>
            <option value="over5000">Over €5,000</option>
            <option value="custom">Custom Range</option>
          </select>
        </div>
      </div>

      <button
        *ngIf="hasActiveFilters()"
        class="clear-filters-btn"
        (click)="clearFilters()"
      >
        <i class="material-icons">cancel</i>
        Clear filters
      </button>
    </div>

    <!-- Custom date range inputs (show when custom date range is selected) -->
    <div class="custom-range-inputs" *ngIf="dateRangeFilter === 'custom'">
      <div class="date-inputs">
        <label>From:</label>
        <input
          type="date"
          [(ngModel)]="dateFilter.from"
          (change)="applyFilters()"
        />
      </div>
      <div class="date-inputs">
        <label>To:</label>
        <input
          type="date"
          [(ngModel)]="dateFilter.to"
          (change)="applyFilters()"
        />
      </div>
    </div>

    <!-- Custom amount range inputs (show when custom amount range is selected) -->
    <div class="custom-range-inputs" *ngIf="amountRangeFilter === 'custom'">
      <div class="amount-inputs">
        <label>Min:</label>
        <input
          type="number"
          [(ngModel)]="amountFilter.min"
          (change)="applyFilters()"
        />
      </div>
      <div class="amount-inputs">
        <label>Max:</label>
        <input
          type="number"
          [(ngModel)]="amountFilter.max"
          (change)="applyFilters()"
        />
      </div>
    </div>
  </div>

  <!-- Main content area -->
  <div
    class="content-area"
    [class.loading]="loading"
    [class.dimmed]="isDetailViewVisible"
  >
    <!-- Error message -->
    <div class="error-message" *ngIf="errorMessage">
      <span>{{ errorMessage }}</span>
    </div>

    <!-- Main content with detail panel -->
    <div class="main-content">
      <!-- Active tab content -->
      <div class="active-content">
        <!-- No results message -->
        <div
          class="no-results"
          *ngIf="filteredInvoices.length === 0 && !loading"
        >
          No invoices found. Try adjusting your filters or search terms.
        </div>

        <!-- Invoices table container -->
        <div *ngIf="filteredInvoices.length > 0" class="users-table-container">
          <!-- Desktop table view -->
          <table class="users-table">
            <thead>
              <tr>
                <th class="sortable-header" (click)="sort('invoiceNumber')">
                  Invoice #
                  <span class="material-icons sort-icon">
                    {{
                      sortColumn === "invoiceNumber"
                        ? sortDirection === "asc"
                          ? "arrow_upward"
                          : "arrow_downward"
                        : "unfold_more"
                    }}
                  </span>
                </th>
                <th class="sortable-header" (click)="sort('date')">
                  Date
                  <span class="material-icons sort-icon">
                    {{
                      sortColumn === "date"
                        ? sortDirection === "asc"
                          ? "arrow_upward"
                          : "arrow_downward"
                        : "unfold_more"
                    }}
                  </span>
                </th>
                <th class="sortable-header" (click)="sort('amount')">
                  Amount
                  <span class="material-icons sort-icon">
                    {{
                      sortColumn === "amount"
                        ? sortDirection === "asc"
                          ? "arrow_upward"
                          : "arrow_downward"
                        : "unfold_more"
                    }}
                  </span>
                </th>
                <th>Status</th>
                <th class="actions-header">Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr
                *ngFor="let invoice of filteredInvoices"
                class="user-row"
                (click)="showInvoiceDetails(invoice)"
              >
                <td>{{ invoice.invoiceNumber }}</td>
                <td>{{ invoice.date | date : "dd/MM/yyyy" }}</td>
                <td>
                  {{
                    invoice.totalAmount | currency : "EUR" : "symbol" : "1.2-2"
                  }}
                </td>
                <td>
                  <span
                    class="status-badge"
                    [class.paid]="invoice.isPaid"
                    [class.outstanding]="!invoice.isPaid && !invoice.isOverdue"
                    [class.overdue]="invoice.isOverdue"
                  >
                    <span class="status-indicator"></span>
                    {{
                      invoice.isOverdue
                        ? "Overdue"
                        : invoice.isPaid
                        ? "Paid"
                        : "Outstanding"
                    }}
                  </span>
                </td>
                <td class="actions-cell">
                  <button
                    class="action-button download-btn"
                    (click)="downloadInvoice(invoice); $event.stopPropagation()"
                  >
                    <i class="material-icons">file_download</i>
                  </button>
                </td>
              </tr>
            </tbody>
          </table>

          <!-- Mobile cards view -->
          <div class="mobile-cards-view">
            <div
              class="user-card"
              *ngFor="let invoice of filteredInvoices"
              (click)="showInvoiceDetails(invoice)"
            >
              <div class="invoice-number">
                {{ invoice.invoiceNumber }}
                <span
                  class="status-badge small"
                  [class.paid]="invoice.isPaid"
                  [class.outstanding]="!invoice.isPaid && !invoice.isOverdue"
                  [class.overdue]="invoice.isOverdue"
                >
                  <span class="status-indicator"></span>
                  {{
                    invoice.isOverdue
                      ? "Overdue"
                      : invoice.isPaid
                      ? "Paid"
                      : "Outstanding"
                  }}
                </span>
              </div>
              <div class="card-body">
                <div class="info-grid">
                  <div class="info-item">
                    <span class="info-label">Date</span>
                    <span class="info-value">{{
                      invoice.date | date : "dd/MM/yyyy"
                    }}</span>
                  </div>
                  <div class="info-item">
                    <span class="info-label">Amount</span>
                    <span class="info-value">{{
                      invoice.totalAmount
                        | currency : "EUR" : "symbol" : "1.2-2"
                    }}</span>
                  </div>
                  <div class="info-item" *ngIf="invoice.isPaid">
                    <span class="info-label">Payment Date</span>
                    <span class="info-value">{{
                      invoice.paymentDate | date : "dd/MM/yyyy"
                    }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading overlay -->
  <div class="loading-overlay" *ngIf="loading">
    <div class="spinner"></div>
    <div class="loading-text">Loading invoices...</div>
  </div>

  <!-- Invoice Detail Panel with Overlay - Moved completely outside the content area -->
  <div
    class="overlay"
    *ngIf="selectedInvoice"
    (click)="closeInvoiceDetails()"
  ></div>
  <div class="detail-panel" *ngIf="selectedInvoice">
    <div class="detail-header">
      <button class="back-button" (click)="closeInvoiceDetails()">
        <i class="material-icons">arrow_back</i>
        <span>Back</span>
      </button>
      <h3>Invoice Details</h3>
      <button class="close-button" (click)="closeInvoiceDetails()">
        <i class="material-icons">close</i>
      </button>
    </div>

    <div class="detail-content">
      <div class="detail-view">
        <!-- Invoice Information -->
        <div class="info-row">
          <label>Invoice Number:</label>
          <div class="value">{{ selectedInvoice.invoiceNumber }}</div>
        </div>

        <div class="info-row">
          <label>Date:</label>
          <div class="value">
            {{ selectedInvoice.invoiceDate | date : "dd/MM/yyyy" }}
          </div>
        </div>

        <div class="info-row">
          <label>Amount:</label>
          <div class="value">
            {{
              selectedInvoice.amount?.total
                | currency : "EUR" : "symbol" : "1.2-2"
            }}
          </div>
        </div>

        <div class="info-row">
          <label>Status:</label>
          <div class="value">
            <span
              class="status-badge"
              [class.paid]="selectedInvoice.status === 'paid'"
              [class.outstanding]="selectedInvoice.status === 'outstanding'"
              [class.overdue]="selectedInvoice.status === 'overdue'"
            >
              <span class="status-indicator"></span>
              {{ selectedInvoice.status | titlecase }}
            </span>
          </div>
        </div>

        <!-- Credit Notes Section -->
        <div class="credit-notes-section">
          <h4>Credit Notes</h4>

          <div
            class="no-credit-notes"
            *ngIf="
              !selectedInvoice.creditNotes ||
              selectedInvoice.creditNotes.length === 0
            "
          >
            No credit notes available for this invoice.
          </div>

          <div
            *ngFor="let creditNote of selectedInvoice.creditNotes"
            class="credit-note-item"
          >
            <div class="credit-note-info">
              <div class="credit-note-number">
                {{ creditNote.number || creditNote.creditNoteNumber }}
              </div>
              <div class="credit-note-date">
                {{ creditNote.date | date : "dd/MM/yyyy" }}
              </div>
              <div class="credit-note-amount">
                {{ creditNote.amount | currency : "EUR" : "symbol" : "1.2-2" }}
              </div>
            </div>
            <button
              class="download-button"
              (click)="downloadCreditNote(creditNote, $event)"
            >
              <i class="material-icons">download</i>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer with Download Button -->
    <div class="detail-footer">
      <button
        class="download-invoice-button"
        (click)="downloadInvoice(selectedInvoice)"
      >
        <i class="material-icons">download</i>
        Download Invoice
      </button>
    </div>
  </div>
</div>
