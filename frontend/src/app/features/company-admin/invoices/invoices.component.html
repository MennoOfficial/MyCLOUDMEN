<!-- Invoices Page - Cloudmen Design System Implementation -->
<div class="page-container" [class.has-detail-open]="isDetailViewVisible">
  <!-- Page Header -->
  <div class="page-header" [class.dimmed]="isDetailViewVisible">
    <h2>Invoices</h2>
  </div>

  <!-- Tab navigation -->
  <div class="tab-navigation" [class.dimmed]="isDetailViewVisible">
    <button
      class="tab-button"
      [class.active]="activeTab === 'outstanding'"
      (click)="switchTab('outstanding')"
    >
      Outstanding
    </button>
    <button
      class="tab-button"
      [class.active]="activeTab === 'paid'"
      (click)="switchTab('paid')"
    >
      Paid
    </button>
  </div>

  <!-- Search and Filter Controls -->
  <div class="search-filter-container" [class.dimmed]="isDetailViewVisible">
    <div class="search-box">
      <i class="material-icons search-icon">search</i>
      <input
        type="text"
        placeholder="Search invoices..."
        [(ngModel)]="searchText"
        (input)="applyFilters()"
      />
      <button *ngIf="searchText" class="clear-search" (click)="clearSearch()">
        <i class="material-icons">close</i>
      </button>
    </div>

    <div class="filters-group">
      <div class="filters">
        <div class="filter-select">
          <select
            id="date-filter"
            [(ngModel)]="dateRangeFilter"
            (change)="applyFilters()"
          >
            <option value="all">All Dates</option>
            <option value="last7">Last 7 days</option>
            <option value="last30">Last 30 days</option>
            <option value="last90">Last 90 days</option>
            <option value="custom">Custom Range</option>
          </select>
        </div>
        <div class="filter-select">
          <select
            id="amount-filter"
            [(ngModel)]="amountRangeFilter"
            (change)="applyFilters()"
          >
            <option value="all">All Amounts</option>
            <option value="under500">Under €500</option>
            <option value="500to1000">€500 - €1,000</option>
            <option value="1000to5000">€1,000 - €5,000</option>
            <option value="over5000">Over €5,000</option>
            <option value="custom">Custom Range</option>
          </select>
        </div>
      </div>

      <button
        *ngIf="hasActiveFilters()"
        class="clear-filters-btn"
        (click)="clearFilters()"
      >
        <i class="material-icons">cancel</i>
        Clear filters
      </button>
    </div>

    <!-- Custom date range inputs (show when custom date range is selected) -->
    <div class="custom-range-inputs" *ngIf="dateRangeFilter === 'custom'">
      <div class="date-inputs">
        <label>From:</label>
        <input
          type="date"
          [(ngModel)]="dateFilter.from"
          (change)="applyFilters()"
        />
      </div>
      <div class="date-inputs">
        <label>To:</label>
        <input
          type="date"
          [(ngModel)]="dateFilter.to"
          (change)="applyFilters()"
        />
      </div>
    </div>

    <!-- Custom amount range inputs (show when custom amount range is selected) -->
    <div class="custom-range-inputs" *ngIf="amountRangeFilter === 'custom'">
      <div class="amount-inputs">
        <label>Min:</label>
        <input
          type="number"
          [(ngModel)]="amountFilter.min"
          (change)="applyFilters()"
        />
      </div>
      <div class="amount-inputs">
        <label>Max:</label>
        <input
          type="number"
          [(ngModel)]="amountFilter.max"
          (change)="applyFilters()"
        />
      </div>
    </div>
  </div>

  <!-- Main content area -->
  <div
    class="content-area"
    [class.loading]="loading"
    [class.dimmed]="isDetailViewVisible"
  >
    <!-- Error message -->
    <div class="error-message" *ngIf="errorMessage">
      <span>{{ errorMessage }}</span>
    </div>

    <!-- Main content with detail panel -->
    <div class="main-content">
      <!-- Active tab content -->
      <div class="active-content">
        <!-- No results message -->
        <div
          class="no-results"
          *ngIf="filteredInvoices.length === 0 && !loading"
        >
          No invoices found. Try adjusting your filters or search terms.
        </div>

        <!-- Invoices table container -->
        <div *ngIf="filteredInvoices.length > 0" class="users-table-container">
          <!-- Desktop table view -->
          <table class="users-table">
            <thead>
              <tr>
                <th class="sortable-header" (click)="sort('paymentReference')">
                  Payment Reference
                  <span class="material-icons sort-icon">
                    {{
                      sortColumn === "paymentReference"
                        ? sortDirection === "asc"
                          ? "arrow_upward"
                          : "arrow_downward"
                        : "unfold_more"
                    }}
                  </span>
                </th>
                <th class="sortable-header" (click)="sort('dueDate')">
                  Due Date
                  <span class="material-icons sort-icon">
                    {{
                      sortColumn === "dueDate"
                        ? sortDirection === "asc"
                          ? "arrow_upward"
                          : "arrow_downward"
                        : "unfold_more"
                    }}
                  </span>
                </th>
                <th class="sortable-header" (click)="sort('amount')">
                  Amount
                  <span class="material-icons sort-icon">
                    {{
                      sortColumn === "amount"
                        ? sortDirection === "asc"
                          ? "arrow_upward"
                          : "arrow_downward"
                        : "unfold_more"
                    }}
                  </span>
                </th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              <tr
                *ngFor="let invoice of filteredInvoices"
                class="user-row"
                (click)="showInvoiceDetails(invoice)"
              >
                <td>{{ invoice.paymentReference || "No reference" }}</td>
                <td>
                  {{
                    invoice.dueDate
                      ? (invoice.dueDate | date : "dd/MM/yyyy")
                      : "No date"
                  }}
                </td>
                <td>
                  {{
                    invoice.totalAmount
                      | currency
                        : invoice.currency || "EUR"
                        : "symbol"
                        : "1.2-2"
                  }}
                </td>
                <td>
                  <span
                    class="status-badge"
                    [class.paid]="invoice.isPaid"
                    [class.outstanding]="!invoice.isPaid && !invoice.isOverdue"
                    [class.overdue]="invoice.isOverdue"
                  >
                    <span class="status-indicator"></span>
                    {{
                      invoice.isOverdue
                        ? "Overdue"
                        : invoice.isPaid
                        ? "Paid"
                        : "Outstanding"
                    }}
                  </span>
                </td>
              </tr>
            </tbody>
          </table>

          <!-- Mobile cards view -->
          <div class="mobile-cards-view">
            <div
              class="user-card"
              *ngFor="let invoice of filteredInvoices"
              (click)="showInvoiceDetails(invoice)"
            >
              <div
                class="invoice-status-indicator"
                [class.paid]="invoice.isPaid"
                [class.outstanding]="!invoice.isPaid && !invoice.isOverdue"
                [class.overdue]="invoice.isOverdue"
              ></div>
              <div class="card-content">
                <div class="card-header">
                  <div class="payment-ref">
                    {{ invoice.paymentReference || "No reference" }}
                  </div>
                  <span
                    class="status-badge small"
                    [class.paid]="invoice.isPaid"
                    [class.outstanding]="!invoice.isPaid && !invoice.isOverdue"
                    [class.overdue]="invoice.isOverdue"
                  >
                    <span class="status-indicator"></span>
                    {{
                      invoice.isOverdue
                        ? "Overdue"
                        : invoice.isPaid
                        ? "Paid"
                        : "Outstanding"
                    }}
                  </span>
                </div>

                <div class="card-body">
                  <div class="amount-display">
                    {{
                      invoice.totalAmount
                        | currency
                          : invoice.currency || "EUR"
                          : "symbol"
                          : "1.2-2"
                    }}
                  </div>

                  <div class="date-display">
                    <span class="label">Due:</span>
                    <span class="value">{{
                      invoice.dueDate | date : "dd MMM yyyy"
                    }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading overlay -->
  <div class="loading-overlay" *ngIf="loading">
    <div class="spinner"></div>
    <div class="loading-text">Loading invoices...</div>
  </div>

  <!-- Invoice Detail Panel with Overlay - Moved completely outside the content area -->
  <div
    class="overlay"
    *ngIf="selectedInvoice"
    (click)="closeInvoiceDetails()"
  ></div>
  <div class="detail-panel" *ngIf="selectedInvoice">
    <div class="detail-header">
      <button class="back-button" (click)="closeInvoiceDetails()">
        <i class="material-icons">arrow_back</i>
        <span>Back</span>
      </button>
      <h3>Invoice Details</h3>
      <button class="close-button" (click)="closeInvoiceDetails()">
        <i class="material-icons">close</i>
      </button>
    </div>

    <div class="detail-content">
      <div class="detail-view">
        <!-- Invoice Summary Card -->
        <div class="invoice-summary-card">
          <div class="invoice-number-badge">
            <span class="label">Payment Reference</span>
            <span class="value">{{
              selectedInvoice.paymentReference || "Not available"
            }}</span>
          </div>

          <div class="invoice-amount">
            {{
              selectedInvoice.amount &&
              selectedInvoice.amount.total !== undefined
                ? (selectedInvoice.amount.total
                  | currency
                    : selectedInvoice.currency || "EUR"
                    : "symbol"
                    : "1.2-2")
                : (selectedInvoice.totalAmount
                    | currency
                      : selectedInvoice.currency || "EUR"
                      : "symbol"
                      : "1.2-2") || "€0.00"
            }}
          </div>

          <div class="invoice-status">
            <span
              class="status-badge"
              [class.paid]="selectedInvoice.isPaid"
              [class.outstanding]="
                !selectedInvoice.isPaid && !selectedInvoice.isOverdue
              "
              [class.overdue]="selectedInvoice.isOverdue"
            >
              <span class="status-indicator"></span>
              {{
                selectedInvoice.isOverdue
                  ? "Overdue"
                  : selectedInvoice.isPaid
                  ? "Paid"
                  : "Outstanding"
              }}
            </span>
          </div>
        </div>

        <!-- Invoice Details Section -->
        <div class="detail-section">
          <h4 class="section-title">
            <i class="material-icons">receipt</i>
            Invoice Details
          </h4>
          <div class="section-content">
            <div class="info-row">
              <label>Invoice Number</label>
              <div class="value">
                {{ selectedInvoice.invoiceNumber || "Not available" }}
              </div>
            </div>

            <div class="info-row" *ngIf="selectedInvoice.description">
              <label>Description</label>
              <div class="value">{{ selectedInvoice.description }}</div>
            </div>

            <div class="info-row" *ngIf="selectedInvoice.purchaseOrderNumber">
              <label>Purchase Order</label>
              <div class="value">{{ selectedInvoice.purchaseOrderNumber }}</div>
            </div>
          </div>
        </div>

        <!-- Important Dates -->
        <div class="detail-section">
          <h4 class="section-title">
            <i class="material-icons">event</i>
            Important Dates
          </h4>
          <div class="section-content">
            <div class="info-row">
              <label>Invoice Date</label>
              <div class="value">
                {{
                  selectedInvoice.invoiceDate
                    ? (selectedInvoice.invoiceDate | date : "dd MMM yyyy")
                    : selectedInvoice.issueDate
                    ? (selectedInvoice.issueDate | date : "dd MMM yyyy")
                    : "Not available"
                }}
              </div>
            </div>

            <div class="info-row">
              <label>Due Date</label>
              <div class="value">
                {{
                  selectedInvoice.dueDate
                    ? (selectedInvoice.dueDate | date : "dd MMM yyyy")
                    : "Not available"
                }}
              </div>
            </div>

            <div class="info-row" *ngIf="selectedInvoice.isPaid">
              <label>Payment Date</label>
              <div class="value">
                {{
                  selectedInvoice.paymentDate
                    ? (selectedInvoice.paymentDate | date : "dd MMM yyyy")
                    : "Not available"
                }}
              </div>
            </div>

            <div class="info-row" *ngIf="selectedInvoice.sent !== undefined">
              <label>Sent Status</label>
              <div class="value">
                {{ selectedInvoice.sent ? "Sent" : "Not sent" }}
              </div>
            </div>
          </div>
        </div>

        <!-- Financial Details -->
        <div class="detail-section">
          <h4 class="section-title">
            <i class="material-icons">euro</i>
            Financial Details
          </h4>
          <div class="section-content">
            <div class="info-row amount-row">
              <label>Subtotal</label>
              <div class="value">
                {{
                  selectedInvoice.amount && selectedInvoice.amount.subtotal
                    ? (selectedInvoice.amount.subtotal
                      | currency
                        : selectedInvoice.currency || "EUR"
                        : "symbol"
                        : "1.2-2")
                    : "Not available"
                }}
              </div>
            </div>

            <div class="info-row amount-row">
              <label>Tax</label>
              <div class="value">
                {{
                  selectedInvoice.amount && selectedInvoice.amount.tax
                    ? (selectedInvoice.amount.tax
                      | currency
                        : selectedInvoice.currency || "EUR"
                        : "symbol"
                        : "1.2-2")
                    : "Not available"
                }}
              </div>
            </div>

            <div class="info-row amount-row total-row">
              <label>Total</label>
              <div class="value total-value">
                {{
                  selectedInvoice.amount &&
                  selectedInvoice.amount.total !== undefined
                    ? (selectedInvoice.amount.total
                      | currency
                        : selectedInvoice.currency || "EUR"
                        : "symbol"
                        : "1.2-2")
                    : (selectedInvoice.totalAmount
                        | currency
                          : selectedInvoice.currency || "EUR"
                          : "symbol"
                          : "1.2-2") || "€0.00"
                }}
              </div>
            </div>
          </div>
        </div>

        <!-- Credit Notes Section -->
        <div class="detail-section">
          <h4 class="section-title">
            <i class="material-icons">receipt_long</i>
            Credit Notes
          </h4>
          <div
            class="no-credit-notes"
            *ngIf="
              !selectedInvoice.creditNotes ||
              selectedInvoice.creditNotes.length === 0
            "
          >
            No credit notes available for this invoice.
          </div>

          <div class="credit-notes-list">
            <div
              *ngFor="let creditNote of selectedInvoice.creditNotes"
              class="credit-note-item"
            >
              <div class="credit-note-info">
                <div class="credit-note-header">
                  <div class="credit-note-number">
                    {{
                      creditNote.number ||
                        creditNote.creditNoteNumber ||
                        "CN-" + creditNote.id
                    }}
                  </div>
                  <div class="credit-note-amount">
                    {{
                      creditNote.amount
                        ? (creditNote.amount
                          | currency
                            : selectedInvoice.currency || "EUR"
                            : "symbol"
                            : "1.2-2")
                        : "€0.00"
                    }}
                  </div>
                </div>
                <div class="credit-note-date">
                  {{
                    creditNote.date
                      ? (creditNote.date | date : "dd MMM yyyy")
                      : "No date available"
                  }}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer with Download Button -->
    <div class="detail-footer">
      <div class="dropdown download-options">
        <button
          class="download-invoice-button"
          (click)="toggleDownloadOptions($event)"
        >
          <i class="material-icons">file_download</i>
          Download Invoice
          <i class="material-icons dropdown-arrow">arrow_drop_down</i>
        </button>
        <div class="dropdown-menu" [class.show]="showDownloadOptions">
          <a
            class="dropdown-item"
            href="javascript:void(0)"
            (click)="downloadInvoice(selectedInvoice, 'pdf')"
          >
            <i class="material-icons">picture_as_pdf</i> PDF
          </a>
          <a
            class="dropdown-item"
            href="javascript:void(0)"
            (click)="downloadInvoice(selectedInvoice, 'ubl/e-fff')"
          >
            <i class="material-icons">receipt</i> UBL/E-FFF (XML)
          </a>
        </div>
      </div>
    </div>
  </div>
</div>
